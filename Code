using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.IO;
using System.Linq;
using System.Text;
using System.Threading;
using System.Threading.Tasks;
using System.Windows.Forms;
using System.Xml.Linq;

namespace game1
{
    public partial class Form1 : Form
    {
        public int wins = 0;
        public int modifier = 0;
        public int x;
        public int y;
        public string difficulty;
        public bool EnemyClick = true;
        private Button[,] buttons = new Button[3, 3];
        Random rand = new Random();
        Label label1 = new Label();
        Button button0 = new Button();
        Button button1 = new Button();
        Button button2 = new Button();
        Button button3 = new Button();
        Button button4 = new Button();

        public Form1()
        {
            InitializeComponent();
            this.Width =370;
            this.Height = 475;
            ButtonCreate();
            MainMenu();
        }

        private void ButtonCreate()
        {
            label1.Text = "Побед подряд: 0";                                    //для меню
            label1.Location = new Point(97, 21);
            label1.Font = new Font(new FontFamily("Times New Roman"), 16);
            label1.Size = new Size(180, 23);
            this.Controls.Add(label1);

            button2.Click += Dif;
            button2.Size = new Size(100, 100);
            button2.Font = new Font(new FontFamily("Times New Roman"), 16);
            button2.Location = new Point(125, 300);
            button2.Text = "Easy";
            button2.Visible = false;
            this.Controls.Add(button2);

            button3.Click += Dif;
            button3.Size = new Size(100, 100);
            button3.Font = new Font(new FontFamily("Times New Roman"), 16);
            button3.Location = new Point(125, 180);
            button3.Text = "Normal";
            button3.Visible = false;
            this.Controls.Add(button3);

            button4.Click += Dif;
            button4.Size = new Size(100, 100);
            button4.Font = new Font(new FontFamily("Times New Roman"), 16);
            button4.Location = new Point(125, 60);
            button4.Text = "Hard";
            button4.Visible = false;
            this.Controls.Add(button4);

            button0.Click += NewGame;                                       //для игры
            button0.Size = new Size(200, 32);
            button0.Font = new Font(new FontFamily("Times New Roman"), 16);
            button0.Location = new Point(125, 58);
            button0.Text = "Новая Игра";
            button0.Visible = false;
            this.Controls.Add(button0);

            button1.Click += RestartGame;
            button1.Size = new Size(100, 32);
            button1.Font = new Font(new FontFamily("Times New Roman"), 16);
            button1.Location = new Point(25, 58);
            button1.Text = "Заново";
            button1.Visible = false;
            this.Controls.Add(button1);



            for (int i = 0; i < 3; i++)
                for (int j = 0; j < 3; j++)
                {
                    buttons[i, j] = new Button();
                    buttons[i, j].Size = new Size(100, 100);
                    buttons[i, j].Location = new Point(25 + 100 * j, 100 + 100 * i);
                    buttons[i, j].Font = new Font(new FontFamily("Times New Roman"), 48);
                    buttons[i, j].Click += ButtonClick;
                    buttons[i, j].Visible = false;
                    this.Controls.Add(buttons[i, j]);
                }
        }

        private void MainMenu()
        {
            for (int i = 0; i < 3; i++)
                for (int j = 0; j < 3; j++)
                {
                    buttons[i, j].Visible = false;
                }
            button0.Visible = false;
            button1.Visible = false;
            button2.Visible = true;
            button3.Visible = true;
            button4.Visible = true;

            label1.Text = "Выберите сложность";
            label1.Location = new Point(80, 21);
            label1.Font = new Font(new FontFamily("Times New Roman"), 16);
            label1.Size = new Size(212, 23);
            this.Controls.Add(label1);
        }

        private void Dif(object sender, EventArgs e)
        {
            switch (sender.GetType().GetProperty("Text").GetValue(sender))
            {
                case "Easy":
                    difficulty = "Easy";
                    modifier = 1;
                    break;
                case "Normal":
                    difficulty = "Normal";
                    modifier = 3;
                    break;
                case "Hard":
                    difficulty = "Hard";
                    modifier = 5;
                    break;
                default:
                    MessageBox.Show("Что-то пошло не так");
                    break;
            }
            GameStart();
        }

        private void GameStart()
        {
            button0.Visible = true;
            button1.Visible = true;
            button2.Visible = false;
            button3.Visible = false;
            button4.Visible = false;

            label1.Text = "Побед подряд: 0";
            label1.Location = new Point(97, 21);
            label1.Font = new Font(new FontFamily("Times New Roman"), 16);
            label1.Size = new Size(180, 23);

            for (int i = 0; i < 3; i++)
                for (int j = 0; j < 3; j++)
                {
                    buttons[i, j].Visible = true;
                }
        }

        private void NewGame(object sender, EventArgs e)
        {
            wins = 0;
            label1.Text = "Побед подряд: " + wins;
            ResetBoard();
            MainMenu();
        }

        private void ButtonClick(object sender, EventArgs e)
        {
            sender.GetType().GetProperty("Text").SetValue(sender, "X");
            sender.GetType().GetProperty("Enabled").SetValue(sender, false);
            EnemyClick = false;
            WinСheck();
            if (FullBoard() == true)
            {
                MessageBox.Show("Ничья");
                EnemyClick = true;
                ResetBoard();
            }
            EnemyTurn();
            WinСheck();
        }

        private void RestartGame(object sender, EventArgs e)
        {
            wins = 0;
            label1.Text = "Побед подряд: " + wins;
            ResetBoard();
        }

        private void ResetBoard()
        {
            for (int i = 0; i < 3; i++)
                for (int j = 0; j < 3; j++)
                {
                    buttons[i, j].Text = "";
                    buttons[i, j].Enabled = true;
                }
        }

        public bool FullBoard()
        {
            for (int i = 0; i < 3; i++)
                for (int j = 0; j < 3; j++)
                {
                    if (buttons[i, j].Enabled == true)
                        return false;
                }
            return true;
        }

        private void EnemyTurn()
        {
            int player;
            switch (difficulty)
            {
                case "Easy":                                                //нет стратегии
                    while (EnemyClick == false && FullBoard() == false)
                    {
                        x = rand.Next(0, 3);
                        y = rand.Next(0, 3);
                        if (buttons[x, y].Enabled == true)
                        {
                            buttons[x, y].Text = "0";
                            buttons[x, y].Enabled = false;
                            EnemyClick = true;
                        }
                    }
                    break;
                case "Normal":
                    player = 0;
                    if (EnemyClick == false)                                //если отдали середину
                        if (buttons[1, 1].Enabled == true)
                        {
                            buttons[1, 1].Text = "0";
                            buttons[1, 1].Enabled = false;
                            EnemyClick = true;
                        }
                    if (EnemyClick == false)                                //защита
                        for (int i = 0; i < 3; i++)
                        {
                            for (int j = 0; j < 3; j++)
                            {
                                if (buttons[i, j].Text == "X")
                                    player++;
                                if (player == 2)
                                {
                                    for (int k = 0; k < 3; k++)
                                        if (buttons[i, k].Enabled == true)
                                        {
                                            buttons[i, k].Text = "0";
                                            buttons[i, k].Enabled = false;
                                            EnemyClick = true;
                                        }
                                    break;
                                }
                            }
                            player = 0;
                        }
                    if (EnemyClick == false)
                        for (int j = 0; j < 3; j++)
                        {
                            for (int i = 0; i < 3; i++)
                            {
                                if (buttons[i, j].Text == "X")
                                    player++;
                                if (player == 2)
                                {
                                    for (int k = 0; k < 3; k++)
                                        if (buttons[k, j].Enabled == true)
                                        {
                                            buttons[k, j].Text = "0";
                                            buttons[k, j].Enabled = false;
                                            EnemyClick = true;
                                        }
                                    break;
                                }
                            }
                            player = 0;
                        }
                    if (EnemyClick == false && buttons[0, 0].Text == "X" && buttons[2, 2].Text == "X")
                    {
                        buttons[1, 1].Text = "0";
                        buttons[1, 1].Enabled = false;
                        EnemyClick = true;
                    }
                    if (EnemyClick == false && buttons[0, 2].Text == "X" && buttons[2, 0].Text == "X")
                    {
                        buttons[1, 1].Text = "0";
                        buttons[1, 1].Enabled = false;
                        EnemyClick = true;
                    }


                    while (EnemyClick == false && FullBoard() == false)                 //нет стратегии
                    {
                        x = rand.Next(0, 3);
                        y = rand.Next(0, 3);
                        if (buttons[x, y].Enabled == true && EnemyClick == false)
                        {
                            buttons[x, y].Text = "0";
                            buttons[x, y].Enabled = false;
                            EnemyClick = true;
                        }
                    }
                    break;
                case "Hard":
                    player = 0;
                    if (EnemyClick == false)                                //если отдали середину
                        if (buttons[1, 1].Enabled == true)
                        {
                            buttons[1, 1].Text = "0";
                            buttons[1, 1].Enabled = false;
                            EnemyClick = true;
                        }

                    if (EnemyClick == false)                                //атака
                        for (int i = 0; i < 3; i++)
                        {
                            for (int j = 0; j < 3; j++)
                            {
                                if (buttons[i, j].Text == "0")
                                    player++;
                                if (player == 2)
                                {
                                    for (int k = 0; k < 3; k++)
                                        if (buttons[i, k].Enabled == true)
                                        {
                                            buttons[i, k].Text = "0";
                                            buttons[i, k].Enabled = false;
                                            EnemyClick = true;
                                        }
                                    break;
                                }
                            }
                            player = 0;
                        }
                    if (EnemyClick == false)
                        for (int j = 0; j < 3; j++)
                        {
                            for (int i = 0; i < 3; i++)
                            {
                                if (buttons[i, j].Text == "0")
                                    player++;
                                if (player == 2)
                                {
                                    for (int k = 0; k < 3; k++)
                                        if (buttons[k, j].Enabled == true)
                                        {
                                            buttons[k, j].Text = "0";
                                            buttons[k, j].Enabled = false;
                                            EnemyClick = true;
                                        }
                                    break;
                                }
                            }
                            player = 0;
                        }
                    if (EnemyClick == false && buttons[0, 0].Text == "0" && buttons[2, 2].Text == "0")
                    {
                        buttons[1, 1].Text = "0";
                        buttons[1, 1].Enabled = false;
                        EnemyClick = true;
                    }
                    if (EnemyClick == false && buttons[0, 2].Text == "0" && buttons[2, 0].Text == "0")
                    {
                        buttons[1, 1].Text = "0";
                        buttons[1, 1].Enabled = false;
                        EnemyClick = true;
                    }

                    if (EnemyClick == false)                                //защита
                        for (int i = 0; i < 3; i++)
                        {
                            for (int j = 0; j < 3; j++)
                            {
                                if (buttons[i, j].Text == "X")
                                    player++;
                                if (player == 2)
                                {
                                    for (int k = 0; k < 3; k++)
                                        if (buttons[i, k].Enabled == true)
                                        {
                                            buttons[i, k].Text = "0";
                                            buttons[i, k].Enabled = false;
                                            EnemyClick = true;
                                        }
                                    break;
                                }
                            }
                            player = 0;
                        }
                    if (EnemyClick == false)
                        for (int j = 0; j < 3; j++)
                        {
                            for (int i = 0; i < 3; i++)
                            {
                                if (buttons[i, j].Text == "X")
                                    player++;
                                if (player == 2)
                                {
                                    for (int k = 0; k < 3; k++)
                                        if (buttons[k, j].Enabled == true)
                                        {
                                            buttons[k, j].Text = "0";
                                            buttons[k, j].Enabled = false;
                                            EnemyClick = true;
                                        }
                                    break;
                                }
                            }
                            player = 0;
                        }
                    if (EnemyClick == false && buttons[0, 0].Text == "X" && buttons[2, 2].Text == "X")
                    {
                        buttons[1, 1].Text = "0";
                        buttons[1, 1].Enabled = false;
                        EnemyClick = true;
                    }
                    if (EnemyClick == false && buttons[0, 2].Text == "X" && buttons[2, 0].Text == "X")
                    {
                        buttons[1, 1].Text = "0";
                        buttons[1, 1].Enabled = false;
                        EnemyClick = true;
                    }


                    while (EnemyClick == false && FullBoard() == false)                 //нет стратегии
                    {
                        x = rand.Next(0, 3);
                        y = rand.Next(0, 3);
                        if (buttons[x, y].Enabled == true && EnemyClick == false)
                        {
                            buttons[x, y].Text = "0";
                            buttons[x, y].Enabled = false;
                            EnemyClick = true;
                        }
                    }
                    break;
                default:
                    MessageBox.Show("Что-то пошло не так");
                    break;
            }
        }

        private void DisableBoard()
        {
            for (int i = 0; i < 3; i++)
                for (int j = 0; j < 3; j++)
                {
                    buttons[i, j].Enabled = false;
                }
            Thread.Sleep(1000);
            for (int i = 0; i < 3; i++)
                for (int j = 0; j < 3; j++)
                {
                    buttons[i, j].Enabled = true;
                }
        }

        private void WinСheck()
        {
            for (int i = 0; i < 3; i++)
            {
                if (buttons[i, 0].Text == "X" && buttons[i, 1].Text == "X" && buttons[i, 2].Text == "X")
                {
                    wins++;
                    label1.Text = "Побед подряд: " + wins;
                    EnemyClick = true;
                    DisableBoard();
                    ResetBoard();
                }
            }
            for (int i = 0; i < 3; i++)
            {
                if (buttons[i, 0].Text == "0" && buttons[i, 1].Text == "0" && buttons[i, 2].Text == "0")
                {
                    wins = 0;
                    label1.Text = "Побед подряд: " + wins;
                    EnemyClick = true;
                    DisableBoard();
                    ResetBoard();
                }
            }

            for (int i = 0; i < 3; i++)
            {
                if (buttons[0, i].Text == "X" && buttons[1, i].Text == "X" && buttons[2, i].Text == "X")
                {
                    wins++;
                    label1.Text = "Побед подряд: " + wins;
                    EnemyClick = true;
                    DisableBoard();
                    ResetBoard();
                }
            }
            for (int i = 0; i < 3; i++)
            {
                if (buttons[0, i].Text == "0" && buttons[1, i].Text == "0" && buttons[2, i].Text == "0")
                {
                    wins = 0;
                    label1.Text = "Побед подряд: " + wins;
                    EnemyClick = true;
                    DisableBoard();
                    ResetBoard();
                }
            }

            if (buttons[0, 0].Text == "X" && buttons[1, 1].Text == "X" && buttons[2, 2].Text == "X")
            {
                wins++;
                label1.Text = "Побед подряд: " + wins;
                EnemyClick = true;
                DisableBoard();
                ResetBoard();
            }
            else if (buttons[0, 0].Text == "0" && buttons[1, 1].Text == "0" && buttons[2, 2].Text == "0")
            {
                wins = 0;
                label1.Text = "Побед подряд: " + wins;
                EnemyClick = true;
                DisableBoard();
                ResetBoard();
            }

            if (buttons[0, 2].Text == "X" && buttons[1, 1].Text == "X" && buttons[2, 0].Text == "X")
            {
                wins++;
                label1.Text = "Побед подряд: " + wins;
                EnemyClick = true;
                DisableBoard();
                ResetBoard();
            }
            else if (buttons[0, 2].Text == "0" && buttons[1, 1].Text == "0" && buttons[2, 0].Text == "0")
            {
                wins = 0;
                label1.Text = "Побед подряд: " + wins;
                EnemyClick = true;
                DisableBoard();
                ResetBoard();
            }
        
        }
    }
}
